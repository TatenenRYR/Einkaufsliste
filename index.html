<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartEinkauf V9 üìë</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5; --primary-dark: #4338ca; --accent: #10b981;
            --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --text-light: #64748b;
            --border: #e2e8f0;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #6366f1; --bg: #0f172a; --card: #1e293b;
                --text: #f8fafc; --text-light: #94a3b8; --border: #334155;
            }
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }

        /* --- Header --- */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;
            padding: 15px 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            position: sticky; top: 0; z-index: 50; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px -3px rgba(0,0,0,0.2);
        }
        .header-content { display: flex; align-items: center; gap: 15px; }
        .menu-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 12px; font-size: 1.2rem; cursor: pointer; }
        .header h1 { margin: 0; font-size: 1.1rem; display: flex; flex-direction: column; line-height: 1.2; }
        .list-title { font-size: 1.3rem; font-weight: bold; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #fbbf24; box-shadow: 0 0 5px rgba(0,0,0,0.5); margin-left: 8px; display: inline-block;}
        .status-dot.online { background: #34d399; box-shadow: 0 0 8px #34d399; }
        
        /* --- Drawer (Menu) --- */
        .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; opacity: 0; pointer-events: none; transition: 0.3s; }
        .drawer-overlay.open { opacity: 1; pointer-events: auto; }
        .drawer { 
            position: fixed; top: 0; left: 0; height: 100%; width: 80%; max-width: 300px; 
            background: var(--card); z-index: 100; transform: translateX(-100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 20px; display: flex; flex-direction: column; box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }
        .drawer.open { transform: translateX(0); }
        .drawer h2 { margin-top: 0; color: var(--primary); font-size: 1.5rem; }
        .drawer-list { flex: 1; overflow-y: auto; margin: 20px 0; }
        .drawer-item { padding: 15px; border-radius: 12px; margin-bottom: 8px; font-weight: 500; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .drawer-item.active { background: #e0e7ff; color: var(--primary); }
        .drawer-item:hover:not(.active) { background: var(--bg); }
        .new-list-btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; width: 100%; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px 15px; }

        /* --- Input --- */
        .input-card {
            background: var(--card); padding: 8px; border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border);
            display: flex; gap: 6px; position: relative; margin-bottom: 20px; align-items: center;
        }
        input { flex: 1; border: none; background: transparent; font-size: 16px; color: var(--text); outline: none; padding: 10px 5px; min-width: 0; }
        .action-btn {
            background: var(--primary); color: white; border: none; width: 40px; height: 40px; flex-shrink: 0;
            border-radius: 12px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .mode-btn { background: #e0e7ff; color: var(--primary); font-size: 1.1rem; }
        .mode-btn.simple { background: #f3f4f6; color: var(--text-light); }
        .mic-btn { background: transparent; color: var(--text-light); border: 1px solid var(--border); }
        .mic-btn.active { background: #fee2e2; color: #ef4444; border-color: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }

        /* --- Magic Recipes --- */
        .magic-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none; }
        .magic-chip {
            background: var(--card); border: 1px solid var(--border); padding: 6px 12px; border-radius: 20px;
            font-size: 0.85rem; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }

        /* --- List --- */
        .cat-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin: 15px 0 5px 5px; font-weight: bold; }
        .item-row {
            background: var(--card); border-radius: 12px; padding: 12px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 10px; border: 1px solid var(--border);
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .item-row.checked { opacity: 0.6; background: var(--bg); border-color: transparent; }
        .item-row.checked .name { text-decoration: line-through; }
        .check-box {
            width: 24px; height: 24px; border: 2px solid var(--text-light); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
        }
        .item-row.checked .check-box { background: var(--accent); border-color: var(--accent); }
        .item-row.checked .check-box::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }
        .details { flex: 1; min-width: 0; }
        .name { font-weight: 600; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .qty-control { display: flex; align-items: center; gap: 5px; background: var(--bg); padding: 2px; border-radius: 8px; flex-shrink: 0; }
        .qty-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: white; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; cursor: pointer; color: var(--text); }
        .qty-val { font-size: 0.8rem; font-weight: bold; min-width: 25px; text-align: center; }
        .del-btn { color: var(--text-light); background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; }

        /* --- Toast & Fab --- */
        .toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 30px;
            display: flex; align-items: center; gap: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 100;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
        .undo-btn { background: none; border: none; color: var(--primary); font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; }
        .fab-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--card); padding: 10px 20px; border-radius: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); border: 1px solid var(--border); z-index: 90;
            display: flex; gap: 20px; align-items: center;
        }
        .fab-btn { background: none; border: none; font-weight: 600; color: var(--primary); font-size: 0.9rem; cursor: pointer; }
        
        #errorMsg { background: #fee2e2; color: #991b1b; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: none; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body>

    <!-- Drawer Menu -->
    <div class="drawer-overlay" id="overlay" onclick="toggleDrawer()"></div>
    <div class="drawer" id="drawer">
        <h2>üìë Deine Listen</h2>
        <div class="drawer-list" id="drawerList">
            <!-- Listen werden hier generiert -->
        </div>
        <button class="new-list-btn" onclick="createNewList()">+ Neue Liste</button>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <button class="menu-btn" onclick="toggleDrawer()">‚ò∞</button>
            <h1>
                <span style="font-size:0.8rem; opacity:0.8; font-weight:normal;">SmartEinkauf</span>
                <span class="list-title" id="headerTitle">Einkauf</span>
            </h1>
        </div>
        <div id="statusDot" class="status-dot"></div>
    </div>

    <div class="container">
        <div id="errorMsg"></div>

        <div class="magic-scroll">
            <div class="magic-chip" onclick="addRecipe('breakfast')">ü•û Fr√ºhst√ºck</div>
            <div class="magic-chip" onclick="addRecipe('pasta')">üçù Pasta</div>
            <div class="magic-chip" onclick="addRecipe('party')">üéâ Party</div>
            <div class="magic-chip" onclick="addRecipe('cleaning')">üßπ Putzen</div>
        </div>

        <div class="input-card">
            <button class="action-btn mode-btn" id="modeBtn" onclick="toggleMode()">‚ú®</button>
            <button class="action-btn mic-btn" id="micBtn" onclick="toggleDictation()">üé§</button>
            <input type="text" id="inputField" placeholder="Was fehlt?" onkeypress="handleEnter(event)">
            <button class="action-btn" onclick="addItem()">+</button>
        </div>

        <div id="listContainer"></div>

        <div id="emptyState" style="text-align: center; padding: 50px 20px; color: var(--text-light); display: none;">
            <div style="font-size: 3rem; margin-bottom: 10px; opacity: 0.3;">üõí</div>
            <p>Liste ist leer.<br>F√ºge etwas hinzu.</p>
        </div>
    </div>

    <div class="fab-bar">
        <button class="fab-btn" onclick="shareList()">üîó Teilen</button>
        <div style="width:1px; height:15px; background:var(--border)"></div>
        <button class="fab-btn" onclick="finishShopping()">üéâ Fertig</button>
    </div>

    <div id="undoToast" class="toast">
        <span id="toastMsg">Gel√∂scht</span>
        <button class="undo-btn" onclick="performUndo()">R√ºckg√§ngig</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyD7pocrD9_46QNoz1jrxggpzkL7E6IhetY",
            authDomain: "einkaufliste-cd5d3.firebaseapp.com",
            databaseURL: "https://einkaufliste-cd5d3-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "einkaufliste-cd5d3",
            storageBucket: "einkaufliste-cd5d3.firebasestorage.app",
            messagingSenderId: "36721747923",
            appId: "1:36721747923:web:dbe48ff974c80435eff126",
            measurementId: "G-37TDK0257N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE
        let currentListId = "Einkauf";
        let items = [];
        let smartMode = true;
        let lastDeleted = [];
        let undoTimer;
        let unsubscribe = null;
        let recognition;
        
        // Multi-List History (Local)
        let myLists = JSON.parse(localStorage.getItem('myLists')) || ["Einkauf"];

        // INIT
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('statusDot').classList.add('online');
                const urlParams = new URLSearchParams(window.location.search);
                const sharedList = urlParams.get('list');
                if (sharedList && !myLists.includes(sharedList)) {
                    myLists.push(sharedList);
                    localStorage.setItem('myLists', JSON.stringify(myLists));
                    currentListId = sharedList;
                }
                subscribeToList(currentListId);
                renderDrawer();
            } else {
                signInAnonymously(auth).catch(e => {
                    document.getElementById('errorMsg').style.display = 'block';
                    document.getElementById('errorMsg').innerText = "Verbindungsproblem: " + e.message;
                });
            }
        });

        // DB & MULTI-LIST LOGIC
        function subscribeToList(listId) {
            if(unsubscribe) unsubscribe(); // Alten Listener stoppen
            
            currentListId = listId;
            document.getElementById('headerTitle').innerText = listId;
            
            // URL Update
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?list=' + listId;
            window.history.pushState({path:newUrl},'',newUrl);
            
            // Highlight Menu
            renderDrawer();

            const listRef = doc(db, "shopping_lists", listId);
            unsubscribe = onSnapshot(listRef, (snap) => {
                if (snap.exists()) {
                    items = snap.data().items || [];
                    renderList();
                } else {
                    saveItems([]); // Init new list
                    items = [];
                    renderList();
                }
            });
        }

        async function saveItems(newItems) {
            try {
                await setDoc(doc(db, "shopping_lists", currentListId), { items: newItems }, { merge: true });
            } catch (e) { console.error(e); }
        }

        window.switchList = (id) => {
            toggleDrawer();
            subscribeToList(id);
        };

        window.createNewList = () => {
            const name = prompt("Name der neuen Liste (z.B. 'Baumarkt'):");
            if (name) {
                if(!myLists.includes(name)) {
                    myLists.push(name);
                    localStorage.setItem('myLists', JSON.stringify(myLists));
                }
                switchList(name);
            }
        };

        window.deleteListRef = (e, name) => {
            e.stopPropagation();
            if(confirm(`Liste '${name}' aus deinem Men√º entfernen? (Daten bleiben erhalten)`)) {
                myLists = myLists.filter(l => l !== name);
                if(myLists.length === 0) myLists = ["Einkauf"];
                localStorage.setItem('myLists', JSON.stringify(myLists));
                if(currentListId === name) switchList(myLists[0]);
                renderDrawer();
            }
        };

        function renderDrawer() {
            const el = document.getElementById('drawerList');
            el.innerHTML = myLists.map(name => `
                <div class="drawer-item ${name === currentListId ? 'active' : ''}" onclick="switchList('${name}')">
                    <span>${name}</span>
                    ${name !== 'Einkauf' ? `<span onclick="deleteListRef(event, '${name}')" style="opacity:0.5;font-size:1.2rem;">&times;</span>` : ''}
                </div>
            `).join('');
        }

        window.toggleDrawer = () => {
            document.getElementById('drawer').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        };

        // PARSER & LOGIC
        function parseSmart(text) {
            // Verbesserte Kategorien (Kasten Cola Fix)
            const categories = {
                "Obst & Gem√ºse": ["apfel", "banane", "salat", "gurke", "tomate", "zwiebel", "kartoffel", "beere", "knoblauch"],
                "Getr√§nke": ["wasser", "saft", "bier", "cola", "limo", "kaffee", "kasten", "pfand", "flasche", "sixpack", "sprudel", "tee", "energy"],
                "K√ºhlregal": ["milch", "k√§se", "joghurt", "butter", "sahne", "ei", "wurst", "quark", "mozarella"],
                "Vorrat": ["brot", "nudeln", "reis", "mehl", "zucker", "√∂l", "konserve", "so√üe", "gew√ºrz", "ketchup"],
                "Haushalt": ["papier", "reiniger", "waschmittel", "zahnpasta", "seife", "duschgel", "shampoo", "m√ºllbeutel"]
            };

            let clean = text;
            const amountRegex = /^(\d+[.,]?\d*)\s*(kg|g|l|ml|stk|pkg|kasten|flasche)?/i;
            let amount = 1, unit = "";
            const match = clean.match(amountRegex);
            if(match) { 
                amount = parseFloat(match[1]); 
                unit = match[2] || ""; 
                clean = clean.replace(match[0], "").trim(); 
            }
            
            // Einheit "Kasten" auch als Getr√§nk-Trigger nutzen
            if(unit.toLowerCase() === 'kasten') clean += " Getr√§nk";

            let category = "Sonstiges";
            const lower = clean.toLowerCase();
            for(const [cat, keywords] of Object.entries(categories)) {
                if(keywords.some(k => lower.includes(k))) { category = cat; break; }
            }

            return { id: Date.now(), name: clean.charAt(0).toUpperCase() + clean.slice(1), amount, unit, category, checked: false };
        }

        window.addItem = async () => {
            const input = document.getElementById('inputField');
            const text = input.value.trim();
            if(!text) return;
            const newItem = smartMode ? parseSmart(text) : { id: Date.now(), name: text, amount: 1, unit: '', category: 'Manuell', checked: false };
            await saveItems([...items, newItem]);
            input.value = '';
        };

        // ... Standard Funktionen (Delete, Check, Qty) ...
        window.updateQty = async (id, change) => {
            await saveItems(items.map(i => i.id === id ? { ...i, amount: Math.max(1, (i.amount||1) + change) } : i));
        };
        window.toggleCheck = async (id) => await saveItems(items.map(i => i.id === id ? { ...i, checked: !i.checked } : i));
        window.deleteItem = async (id) => {
            const item = items.find(i => i.id === id); lastDeleted = [item];
            await saveItems(items.filter(i => i.id !== id)); showUndo();
        };
        window.clearChecked = async () => {
            const toDel = items.filter(i => i.checked); if(!toDel.length) return;
            lastDeleted = toDel; await saveItems(items.filter(i => !i.checked)); showUndo();
        };
        window.performUndo = async () => {
            if(lastDeleted.length) { await saveItems([...items, ...lastDeleted]); lastDeleted=[]; document.getElementById('undoToast').classList.remove('show'); }
        };
        function showUndo() {
            const t = document.getElementById('undoToast'); t.classList.add('show');
            clearTimeout(undoTimer); undoTimer = setTimeout(() => t.classList.remove('show'), 4000);
        }
        window.finishShopping = () => {
            if(!items.some(i => i.checked)) return alert("Nichts erledigt!");
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.7 } });
            window.clearChecked();
        };
        
        // RECIPES
        window.addRecipe = async (t) => {
             const r = { 'breakfast':['Eier','Speck'], 'pasta':['Nudeln','So√üe'], 'party':['Cola','Chips'], 'cleaning':['Reiniger','T√ºcher'] };
             const add = r[t].map(n => parseSmart(n));
             await saveItems([...items, ...add]);
        };

        // INPUT HELPERS
        window.toggleMode = () => {
            smartMode = !smartMode;
            const btn = document.getElementById('modeBtn');
            const inp = document.getElementById('inputField');
            btn.innerText = smartMode ? "‚ú®" : "üìù";
            btn.className = smartMode ? "action-btn mode-btn" : "action-btn mode-btn simple";
            inp.placeholder = smartMode ? "Was fehlt?" : "Exakter Text";
            inp.focus();
        };
        window.handleEnter = (e) => { if(e.key === 'Enter') window.addItem(); };
        window.shareList = () => { navigator.clipboard.writeText(window.location.href); alert("Link kopiert!"); };

        // SPEECH
        function initSpeech() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SR(); recognition.lang = 'de-DE'; recognition.continuous = false;
                recognition.onstart = () => document.getElementById('micBtn').classList.add('active');
                recognition.onend = () => document.getElementById('micBtn').classList.remove('active');
                recognition.onresult = (e) => document.getElementById('inputField').value = e.results[0][0].transcript;
            } else { document.getElementById('micBtn').style.display = 'none'; }
        }
        initSpeech();
        window.toggleDictation = () => { if(recognition) recognition.start(); };

        // RENDER
        function renderList() {
            const container = document.getElementById('listContainer');
            container.innerHTML = '';
            if(items.length === 0) { document.getElementById('emptyState').style.display = 'block'; return; }
            document.getElementById('emptyState').style.display = 'none';

            const groups = {};
            [...items].sort((a,b) => a.checked - b.checked).forEach(i => {
                const c = i.category || "Sonstiges"; if(!groups[c]) groups[c]=[]; groups[c].push(i);
            });

            const order = ["Obst & Gem√ºse", "K√ºhlregal", "Vorrat", "Getr√§nke", "Haushalt", "Manuell", "Sonstiges"];
            [...order, ...Object.keys(groups)].filter((v,i,a)=>a.indexOf(v)===i).forEach(cat => {
                if(groups[cat] && groups[cat].length) {
                    container.innerHTML += `<div class="cat-title">${cat}</div>`;
                    groups[cat].forEach(item => {
                        const qty = (smartMode || item.amount>1) ? `
                            <div class="qty-control" onclick="event.stopPropagation()">
                                <div class="qty-btn" onclick="updateQty(${item.id}, -1)">-</div>
                                <div class="qty-val">${item.amount}${item.unit}</div>
                                <div class="qty-btn" onclick="updateQty(${item.id}, 1)">+</div>
                            </div>` : '';
                        
                        const el = document.createElement('div');
                        el.className = `item-row ${item.checked ? 'checked' : ''}`;
                        el.innerHTML = `
                            <div class="check-box" onclick="toggleCheck(${item.id})"></div>
                            <div class="details" onclick="toggleCheck(${item.id})"><div class="name">${item.name}</div></div>
                            ${qty}
                            <button class="del-btn" onclick="deleteItem(${item.id})">&times;</button>
                        `;
                        container.appendChild(el);
                    });
                }
            });
        }
    </script>
</body>
</html>

