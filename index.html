<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>SmartEinkauf Sync ‚òÅÔ∏è</title>
    
    <!-- Drag & Drop + Konfetti -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1e40af; --accent: #10b981;
            --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --text-light: #64748b;
            --border: #e2e8f0; --input-bg: #ffffff;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #3b82f6; --bg: #0f172a; --card: #1e293b;
                --text: #f8fafc; --text-light: #94a3b8; --border: #334155; --input-bg: #0f172a;
            }
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 120px; }

        /* UI Styles */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 15px 20px 25px 20px;
            border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; position: sticky; top: 0; z-index: 50;
            display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 20px -5px rgba(0,0,0,0.2);
        }
        .list-name { font-size: 1.2rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; box-shadow: 0 0 5px rgba(0,0,0,0.2); transition: background 0.3s; }
        .status-dot.online { background: #4ade80; box-shadow: 0 0 8px #4ade80; }
        .status-dot.error { background: #ef4444; }

        .container { max-width: 600px; margin: -20px auto 0; padding: 0 15px; position: relative; z-index: 60; }
        .card { background: var(--card); padding: 15px; border-radius: 16px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }

        .input-group { display: flex; gap: 8px; }
        input[type="text"] { flex: 1; padding: 12px; border: 2px solid var(--border); border-radius: 12px; font-size: 16px; outline: none; background: var(--input-bg); color: var(--text); }
        input:focus { border-color: var(--primary); }
        .add-btn { background: var(--primary); color: white; border: none; width: 48px; border-radius: 12px; font-size: 1.5rem; cursor: pointer; }
        .mic-btn { background: var(--border); color: var(--text-light); border: none; width: 44px; border-radius: 12px; font-size: 1.2rem; cursor: pointer; }
        .mic-btn.active { background: #ef4444; color: white; }

        ul { list-style: none; padding: 0; margin: 0; }
        li { background: var(--card); margin-bottom: 8px; border-radius: 12px; padding: 12px; display: flex; align-items: center; border: 1px solid var(--border); transition: 0.2s; }
        li.checked { opacity: 0.5; background: var(--bg); }
        li.checked .item-name { text-decoration: line-through; }
        
        .check-circle { width: 22px; height: 22px; border: 2px solid var(--text-light); border-radius: 50%; margin-right: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        li.checked .check-circle { background: var(--accent); border-color: var(--accent); }
        li.checked .check-circle::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }

        .item-content { flex: 1; overflow: hidden; }
        .item-name { font-weight: 600; font-size: 1rem; }
        .item-meta { font-size: 0.75rem; color: var(--text-light); display: flex; gap: 5px; align-items: center; margin-top: 2px; }
        .badge { background: rgba(37, 99, 235, 0.1); color: var(--primary); padding: 1px 5px; border-radius: 4px; }

        .total-bar { position: fixed; bottom: 80px; left: 0; right: 0; background: var(--card); border-top: 1px solid var(--border); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; z-index: 80; }
        .fab-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; background: var(--card); padding: 10px 25px; border-radius: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); border: 1px solid var(--border); z-index: 90; }
        .btn-action { background: none; border: none; font-weight: 600; color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; }

        /* Menu Drawer */
        .drawer { position: fixed; top: 0; left: 0; height: 100%; width: 280px; background: var(--card); z-index: 100; transform: translateX(-100%); transition: transform 0.3s; padding: 20px; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .drawer.open { transform: translateX(0); }
        .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .drawer-overlay.open { opacity: 1; pointer-events: auto; }
        .list-item { padding: 12px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; }
        .list-item.active { background: rgba(37, 99, 235, 0.1); color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <!-- Drawer -->
    <div class="drawer-overlay" id="overlay" onclick="toggleDrawer()"></div>
    <div class="drawer" id="drawer">
        <h2>üìë Listen w√§hlen</h2>
        <div id="drawerList"></div>
        <button onclick="createNewList()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; margin-top:20px; cursor:pointer;">+ Neue Liste</button>
        <p style="margin-top:auto; font-size:0.8rem; color:#94a3b8;">Status: <span id="connectionStatus">Verbinde...</span></p>
    </div>

    <!-- Header -->
    <div class="header">
        <div onclick="toggleDrawer()">
            <span style="font-size:0.75rem; opacity:0.8; text-transform:uppercase;">SmartEinkauf Sync</span>
            <div class="list-name"><span id="headerListName">Einkauf</span> ‚ñº <div class="status-dot" id="statusDot"></div></div>
        </div>
        <button onclick="toggleDrawer()" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:8px 12px; border-radius:8px; cursor:pointer;">‚ò∞</button>
    </div>

    <div class="container">
        <!-- Input -->
        <div class="card">
            <div class="input-group">
                <button class="mic-btn" id="micBtn" onclick="toggleDictation()">üé§</button>
                <input type="text" id="smartInput" placeholder="Z.B. 2 Milch Aldi..." onkeypress="handleEnter(event)">
                <button class="add-btn" onclick="addItem()">+</button>
            </div>
        </div>

        <!-- List -->
        <ul id="shoppingList"></ul>
        
        <div id="emptyState" style="text-align: center; padding: 40px; color: var(--text-light); display: none;">
            <div style="font-size: 3rem; opacity: 0.5;">‚òÅÔ∏è</div>
            <p>Liste ist leer.<br>Daten werden live synchronisiert.</p>
        </div>
    </div>

    <div class="total-bar">
        <span>Summe:</span> <span id="totalSum" style="color: var(--primary);">0,00 ‚Ç¨</span>
    </div>

    <div class="fab-container">
        <button class="btn-action" onclick="shareList()">üîó Einladen</button>
        <div style="width: 1px; background: var(--border);"></div>
        <button class="btn-action" onclick="finishShopping()">üéâ Fertig</button>
    </div>

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, arrayUnion, arrayRemove, getDoc } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // DEINE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyD7pocrD9_46QNoz1jrxggpzkL7E6IhetY",
            authDomain: "einkaufliste-cd5d3.firebaseapp.com",
            databaseURL: "https://einkaufliste-cd5d3-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "einkaufliste-cd5d3",
            storageBucket: "einkaufliste-cd5d3.firebasestorage.app",
            messagingSenderId: "36721747923",
            appId: "1:36721747923:web:dbe48ff974c80435eff126",
            measurementId: "G-37TDK0257N"
        };

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Globals accessible from HTML ---
        window.currentListId = "Einkauf"; 
        window.items = []; // Local cache for rendering
        let unsubscribe = null; // Firestore listener

        // --- Auth & Startup ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                updateStatus(true);
                // Check URL for shared list
                const urlParams = new URLSearchParams(window.location.search);
                const sharedList = urlParams.get('list');
                if (sharedList) window.currentListId = sharedList;
                
                subscribeToList(window.currentListId);
                renderDrawer();
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error("Auth Error", error);
                    updateStatus(false);
                    alert("Fehler: Bitte aktiviere 'Anonymous Auth' in der Firebase Console!");
                });
            }
        });

        function updateStatus(online) {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('connectionStatus');
            if(online) {
                dot.className = "status-dot online";
                txt.innerText = "Verbunden ‚úÖ";
                txt.style.color = "green";
            } else {
                dot.className = "status-dot error";
                txt.innerText = "Fehler / Offline ‚ùå";
                txt.style.color = "red";
            }
        }

        // --- Firestore Logic ---
        function subscribeToList(listId) {
            if(unsubscribe) unsubscribe(); // Alten Listener stoppen
            
            window.currentListId = listId;
            document.getElementById('headerListName').innerText = listId;
            
            const listRef = doc(db, "shopping_lists", listId);
            
            unsubscribe = onSnapshot(listRef, (docSnap) => {
                if (docSnap.exists()) {
                    window.items = docSnap.data().items || [];
                    renderList();
                } else {
                    // Neue Liste erstellen wenn sie nicht existiert
                    setDoc(listRef, { items: [], createdAt: new Date() });
                    window.items = [];
                    renderList();
                }
            }, (error) => {
                console.error("Datenbank Fehler:", error);
                if(error.code === 'permission-denied') {
                    alert("Datenbank Zugriff verweigert! Hast du 'Firestore' im 'Test Mode' erstellt?");
                }
            });

            // Update URL ohne Reload
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?list=' + listId;
            window.history.pushState({path:newUrl},'',newUrl);
        }

        // --- Actions (Global Window Functions) ---
        window.createNewList = function() {
            const name = prompt("Name der neuen Liste (z.B. 'Baumarkt'):");
            if(name) {
                subscribeToList(name);
                toggleDrawer();
            }
        };

        window.toggleDrawer = function() {
            document.getElementById('drawer').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
            renderDrawer(); // Re-Render Recent Lists logic could go here
        };

        // Simuliertes Drawer Men√º (in echt m√ºsste man eine User-Settings Collection haben f√ºr Listen-√úbersicht)
        // Hier Hardcoden wir die "Favoriten" oder merken uns lokal besuchte
        function renderDrawer() {
            const history = JSON.parse(localStorage.getItem('my_lists') || '["Einkauf"]');
            if(!history.includes(window.currentListId)) {
                history.push(window.currentListId);
                localStorage.setItem('my_lists', JSON.stringify(history));
            }

            const el = document.getElementById('drawerList');
            el.innerHTML = history.map(name => `
                <div class="list-item ${name === window.currentListId ? 'active' : ''}" onclick="switchList('${name}')">
                    <span>${name}</span>
                </div>
            `).join('');
        }
        window.switchList = (name) => { subscribeToList(name); toggleDrawer(); };

        window.addItem = async function() {
            const input = document.getElementById('smartInput');
            const text = input.value.trim();
            if(!text) return;

            const newItem = parseInput(text); // Helper Function call
            const listRef = doc(db, "shopping_lists", window.currentListId);
            
            // Optimistic UI Update (optional, here we wait for sync for simplicity/truth)
            await updateDoc(listRef, {
                items: arrayUnion(newItem)
            });
            input.value = '';
        };

        window.toggleCheck = async function(itemId) {
            const listRef = doc(db, "shopping_lists", window.currentListId);
            // Firestore Array Update ist tricky f√ºr einzelne Felder.
            // Strategie: Komplettes Array lesen/schreiben ist bei kleinen Listen OK.
            const updatedItems = window.items.map(i => {
                if(i.id === itemId) return { ...i, checked: !i.checked };
                return i;
            });
            await updateDoc(listRef, { items: updatedItems });
        };

        window.deleteItem = async function(itemId) {
            const listRef = doc(db, "shopping_lists", window.currentListId);
            const itemToDelete = window.items.find(i => i.id === itemId);
            await updateDoc(listRef, {
                items: arrayRemove(itemToDelete) // Achtung: arrayRemove braucht exaktes Objekt. Besser Filter:
            }).catch(async () => {
                // Fallback: Manuell filtern
                const newItems = window.items.filter(i => i.id !== itemId);
                await updateDoc(listRef, { items: newItems });
            });
        };

        window.finishShopping = async function() {
            const hasChecked = window.items.some(i => i.checked);
            if(!hasChecked) return alert("Nichts abgehakt!");
            
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            
            const listRef = doc(db, "shopping_lists", window.currentListId);
            const remaining = window.items.filter(i => !i.checked);
            await updateDoc(listRef, { items: remaining });
        };

        window.shareList = function() {
            // Einfach URL teilen
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => alert("Link kopiert! Schicke ihn an deinen Partner."));
        };

        // --- Helper: Parsing (gleiche Logik wie vorher) ---
        const categoryMap = {
            "obst": "üçé", "k√ºhlung": "ü•õ", "brot": "ü•ñ", "getr√§nke": "ü•§", 
            "haushalt": "üßª", "vorrat": "üçù", "fleisch": "ü•©", "drogerie": "üß¥"
        };
        const knownStores = ["Aldi", "Lidl", "Rewe", "Edeka", "Netto", "Dm", "Rossmann"];

        function parseInput(text) {
            let cleanText = text.replace(/\.$/, "");
            
            // Preis
            let price = 0;
            const priceRegex = /(\d+[.,]\d{1,2})\s*(‚Ç¨|euro)/i;
            const matchP = cleanText.match(priceRegex);
            if(matchP) {
                price = parseFloat(matchP[1].replace(',', '.'));
                cleanText = cleanText.replace(matchP[0], "").trim();
            }

            // Menge
            const amountRegex = /^(\d+[.,]?\d*|ein|eine)\s*(kg|g|l|ml|stk|pkg|beutel|dose|flasche)?/i;
            let amount = "", unit = "";
            const matchA = cleanText.match(amountRegex);
            if (matchA) {
                amount = matchA[1]; unit = matchA[2] || "";
                cleanText = cleanText.replace(matchA[0], "").trim();
            }

            // Store & Kat
            let store = "Allg."; let icon = "üõí";
            const words = cleanText.split(" ");
            const remaining = [];
            words.forEach(w => {
                if (knownStores.includes(w.charAt(0).toUpperCase() + w.slice(1))) store = w;
                else remaining.push(w);
            });
            cleanText = remaining.join(" ");

            const searchVal = cleanText.toLowerCase();
            for (const key in categoryMap) {
                if (searchVal.includes(key)) icon = categoryMap[key];
            }

            return {
                id: Date.now(),
                name: cleanText.charAt(0).toUpperCase() + cleanText.slice(1),
                amount, unit, store, icon, price, checked: false
            };
        }

        // --- Rendering ---
        function renderList() {
            const el = document.getElementById('shoppingList');
            el.innerHTML = '';
            
            document.getElementById('emptyState').style.display = window.items.length ? 'none' : 'block';

            // Sort: Checked bottom
            const sorted = [...window.items].sort((a,b) => a.checked - b.checked);
            let sum = 0;

            sorted.forEach(item => {
                sum += (item.price || 0);
                const li = document.createElement('li');
                li.className = item.checked ? 'checked' : '';
                li.innerHTML = `
                    <div class="check-circle" onclick="toggleCheck(${item.id})"></div>
                    <div class="item-content">
                        <div class="item-name">${item.name}</div>
                        <div class="item-meta">
                            ${item.amount ? `<span><b>${item.amount}</b> ${item.unit}</span>` : ''}
                            <span class="badge">${item.icon} ${item.store}</span>
                            ${item.price ? `<span>${item.price.toFixed(2)}‚Ç¨</span>` : ''}
                        </div>
                    </div>
                    <button onclick="deleteItem(${item.id})" style="border:none;background:none;font-size:1.2rem;color:#94a3b8;">&times;</button>
                `;
                el.appendChild(li);
            });
            document.getElementById('totalSum').innerText = sum.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' });
        }

        // Input Handler
        window.handleEnter = (e) => { if(e.key === 'Enter') window.addItem(); };

        // --- Speech (Legacy JS) ---
        window.initSpeech = function() {
             const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
             if(!SR) { document.getElementById('micBtn').style.display = 'none'; return; }
             const rec = new SR(); rec.lang = 'de-DE';
             rec.onstart = () => document.getElementById('micBtn').classList.add('active');
             rec.onend = () => document.getElementById('micBtn').classList.remove('active');
             rec.onresult = (e) => document.getElementById('smartInput').value = e.results[0][0].transcript;
             window.toggleDictation = () => rec.start();
        }
        window.initSpeech();

    </script>
</body>
</html>

