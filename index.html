<!DOCTYPE html><html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Einkaufsliste mit QR-Sync</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; background: #f0f0f0; }
    input, button, select { width: 100%; padding: 0.5rem; margin: 0.3rem 0; box-sizing: border-box; }
    ul { list-style: none; padding: 0; }
    li { padding: 0.5rem; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; cursor: pointer; flex-wrap: wrap; }
    .erledigt { text-decoration: line-through; opacity: 0.5; }
    .produkt-info { display: flex; align-items: center; gap: 0.6rem; flex: 1; }
    .produkt-info i { font-size: 1.3rem; }
    .aktionen button { margin-left: 0.3rem; }
    #qrCodeCanvas, #qrScanner { margin-top: 1rem; text-align: center; }
  </style>
</head>
<body>
<h2>Einkaufsliste</h2>

<input id="produktInput" placeholder="Produktname">
<input id="mengeInput" placeholder="Menge">
<input id="marktInput" placeholder="Markt (optional)">
<button onclick="hinzufuegen()">Hinzufügen</button>
<button onclick="zeigeQR()">QR anzeigen</button>
<button onclick="starteQRScan()">QR scannen</button>

<ul id="liste"></ul>

<div id="qrCodeCanvas"></div>
<div id="qrScanner"></div>

<script>
let produkte = JSON.parse(localStorage.getItem("produkte")) || [];

function speichereProdukte() {
  localStorage.setItem("produkte", JSON.stringify(produkte));
}

function renderListe() {
  const ul = document.getElementById("liste");
  ul.innerHTML = '';
  const sortiert = [...produkte.filter(p => !p.erledigt), ...produkte.filter(p => p.erledigt)];
  sortiert.forEach(p => {
    const li = document.createElement("li");
    li.className = p.erledigt ? "erledigt" : "";
    li.innerHTML = `
      <span class="produkt-info" onclick="umschaltenErledigt(${p.id})">
        <i class="bi ${p.icon}"></i>
        <span><strong>${p.name}</strong> (${p.menge})<br><small>${p.kategorie}${p.markt ? " @ " + p.markt : ""}</small></span>
      </span>
      <span class="aktionen">
        <button onclick="aendereMenge(${p.id},1); event.stopPropagation()">+</button>
        <button onclick="aendereMenge(${p.id},-1); event.stopPropagation()">-</button>
      </span>
    `;
    ul.appendChild(li);
  });
}

function hinzufuegen() {
  const name = produktInput.value.trim();
  const menge = mengeInput.value.trim();
  const markt = marktInput.value.trim();
  if (!name || !menge) return;
  const { kategorie, icon } = erkenneKategorieUndIcon(name);
  produkte.push({ id: Date.now(), name, menge, markt, kategorie, icon, erledigt: false });
  speichereProdukte();
  produktInput.value = mengeInput.value = marktInput.value = '';
  renderListe();
}

function erkenneKategorieUndIcon(name) {
  const n = name.toLowerCase();
  if (n.includes("cola") || n.includes("wasser")) return { kategorie: "Getränke", icon: "bi-cup-straw" };
  if (n.includes("ei")) return { kategorie: "Frische", icon: "bi-egg-fried" };
  if (n.includes("apfel") || n.includes("banane")) return { kategorie: "Obst", icon: "bi-apple" };
  if (n.includes("brot")) return { kategorie: "Backwaren", icon: "bi-basket" };
  if (n.includes("milch") || n.includes("käse")) return { kategorie: "Milchprodukte", icon: "bi-droplet" };
  return { kategorie: "Sonstiges", icon: "bi-bag" };
}

function umschaltenErledigt(id) {
  const p = produkte.find(p => p.id === id);
  if (p) {
    p.erledigt = !p.erledigt;
    speichereProdukte();
    renderListe();
  }
}

function aendereMenge(id, delta) {
  const p = produkte.find(p => p.id === id);
  const m = p.menge.match(/(\d+)(.*)/);
  if (m) {
    let n = parseInt(m[1]) + delta;
    if (n <= 0) produkte = produkte.filter(p => p.id !== id);
    else p.menge = `${n}${m[2]}`;
    speichereProdukte();
    renderListe();
  }
}

function zeigeQR() {
  const div = document.getElementById("qrCodeCanvas");
  div.innerHTML = '';
  QRCode.toCanvas(document.createElement('canvas'), JSON.stringify(produkte), { width: 256 }, (err, canvas) => {
    if (!err) div.appendChild(canvas);
  });
}

function starteQRScan() {
  const scannerDiv = document.getElementById("qrScanner");
  scannerDiv.innerHTML = '';
  const scanner = new Html5Qrcode("qrScanner");
  Html5Qrcode.getCameras().then(devices => {
    if (devices && devices.length) {
      scanner.start(
        devices[0].id,
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          try {
            produkte = JSON.parse(qrCodeMessage);
            speichereProdukte();
            renderListe();
            scanner.stop();
            scannerDiv.innerHTML = '';
          } catch (e) {
            alert("Fehler beim Importieren der Liste");
          }
        },
        errorMessage => {}
      );
    }
  });
}

renderListe();
</script>
</body>
</html>
