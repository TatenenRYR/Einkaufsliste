<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartEinkauf V8 üé§</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --accent: #10b981;
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --text-light: #64748b;
            --border: #e2e8f0; --danger: #ef4444;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #818cf8; --bg: #0f172a; --card: #1e293b;
                --text: #f8fafc; --text-light: #94a3b8; --border: #334155;
            }
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }

        /* --- Header --- */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;
            padding: 15px 20px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            position: sticky; top: 0; z-index: 50; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px -3px rgba(0,0,0,0.2);
        }
        .header h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #fbbf24; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .status-dot.online { background: #34d399; box-shadow: 0 0 8px #34d399; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 20px 15px; }

        /* --- Input --- */
        .input-card {
            background: var(--card); padding: 8px; border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border);
            display: flex; gap: 6px; position: relative; margin-bottom: 20px; align-items: center;
        }
        input { flex: 1; border: none; background: transparent; font-size: 16px; color: var(--text); outline: none; padding: 10px 5px; min-width: 0; }
        
        /* Input Buttons */
        .action-btn {
            background: var(--primary); color: white; border: none; width: 40px; height: 40px; flex-shrink: 0;
            border-radius: 12px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.95); }
        
        .mode-btn { background: #e0e7ff; color: var(--primary); font-size: 1.1rem; }
        .mode-btn.simple { background: #f3f4f6; color: var(--text-light); }
        
        .mic-btn { background: transparent; color: var(--text-light); border: 1px solid var(--border); }
        .mic-btn.active { background: #fee2e2; color: #ef4444; border-color: #ef4444; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }

        /* --- Magic Recipes --- */
        .magic-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none; }
        .magic-chip {
            background: var(--card); border: 1px solid var(--border); padding: 6px 12px; border-radius: 20px;
            font-size: 0.85rem; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        /* --- List --- */
        .cat-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); margin: 15px 0 5px 5px; font-weight: bold; }
        
        .item-row {
            background: var(--card); border-radius: 12px; padding: 12px; margin-bottom: 8px;
            display: flex; align-items: center; gap: 10px; border: 1px solid var(--border);
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .item-row.checked { opacity: 0.6; background: var(--bg); border-color: transparent; }
        .item-row.checked .name { text-decoration: line-through; }
        
        .check-box {
            width: 24px; height: 24px; border: 2px solid var(--text-light); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
        }
        .item-row.checked .check-box { background: var(--accent); border-color: var(--accent); }
        .item-row.checked .check-box::after { content: '‚úì'; color: white; font-size: 14px; font-weight: bold; }

        .details { flex: 1; min-width: 0; }
        .name { font-weight: 600; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .qty-control { display: flex; align-items: center; gap: 5px; background: var(--bg); padding: 2px; border-radius: 8px; flex-shrink: 0; }
        .qty-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: white; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; cursor: pointer; color: var(--text); }
        .qty-val { font-size: 0.8rem; font-weight: bold; min-width: 25px; text-align: center; }

        .del-btn { color: var(--text-light); background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; }

        /* --- Toast (Undo) --- */
        .toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 30px;
            display: flex; align-items: center; gap: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 100;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
        .undo-btn { background: none; border: none; color: var(--primary); font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Fab --- */
        .fab-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--card); padding: 10px 20px; border-radius: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); border: 1px solid var(--border); z-index: 90;
            display: flex; gap: 20px; align-items: center;
        }
        .fab-btn { background: none; border: none; font-weight: 600; color: var(--primary); font-size: 0.9rem; cursor: pointer; }

        #errorMsg { background: #fee2e2; color: #991b1b; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: none; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body>

    <div class="header">
        <h1>üõí SmartEinkauf <div id="statusDot" class="status-dot"></div></h1>
        <button onclick="shareList()" style="background:rgba(255,255,255,0.2); border:none; color:white; padding:5px 12px; border-radius:15px; font-size:0.85rem;">üîó Teilen</button>
    </div>

    <div class="container">
        
        <div id="errorMsg"></div>

        <!-- Magic Recipes -->
        <div class="magic-scroll">
            <div class="magic-chip" onclick="addRecipe('breakfast')">ü•û Fr√ºhst√ºck</div>
            <div class="magic-chip" onclick="addRecipe('pasta')">üçù Pasta</div>
            <div class="magic-chip" onclick="addRecipe('party')">üéâ Party</div>
            <div class="magic-chip" onclick="addRecipe('cleaning')">üßπ Putzen</div>
        </div>

        <!-- Input -->
        <div class="input-card">
            <button class="action-btn mode-btn" id="modeBtn" onclick="toggleMode()">‚ú®</button>
            <button class="action-btn mic-btn" id="micBtn" onclick="toggleDictation()">üé§</button>
            <input type="text" id="inputField" placeholder="Was fehlt?" onkeypress="handleEnter(event)">
            <button class="action-btn" onclick="addItem()">+</button>
        </div>

        <div id="listContainer"></div>

        <div id="emptyState" style="text-align: center; padding: 50px 20px; color: var(--text-light); display: none;">
            <div style="font-size: 3rem; margin-bottom: 10px; opacity: 0.3;">üéôÔ∏è</div>
            <p>Liste leer.<br>Sprich oder tippe etwas ein.</p>
        </div>
    </div>

    <div class="fab-bar">
        <button class="fab-btn" onclick="clearChecked()">üóëÔ∏è Aufr√§umen</button>
        <div style="width:1px; height:15px; background:var(--border)"></div>
        <button class="fab-btn" onclick="finishShopping()">üéâ Fertig</button>
    </div>

    <!-- Undo Toast -->
    <div id="undoToast" class="toast">
        <span id="toastMsg">Gel√∂scht</span>
        <button class="undo-btn" onclick="performUndo()">R√ºckg√§ngig</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyD7pocrD9_46QNoz1jrxggpzkL7E6IhetY",
            authDomain: "einkaufliste-cd5d3.firebaseapp.com",
            databaseURL: "https://einkaufliste-cd5d3-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "einkaufliste-cd5d3",
            storageBucket: "einkaufliste-cd5d3.firebasestorage.app",
            messagingSenderId: "36721747923",
            appId: "1:36721747923:web:dbe48ff974c80435eff126",
            measurementId: "G-37TDK0257N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE
        let currentListId = "Einkauf";
        let items = [];
        let smartMode = true;
        let lastDeletedItems = []; // F√ºr Undo
        let undoTimeout;
        let recognition; // Speech API

        // AUTH
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('statusDot').classList.add('online');
                document.getElementById('errorMsg').style.display = 'none';
                
                const urlParams = new URLSearchParams(window.location.search);
                const sharedList = urlParams.get('list');
                if (sharedList) currentListId = sharedList;
                
                subscribeToList(currentListId);
            } else {
                signInAnonymously(auth).catch(handleError);
            }
        });

        function handleError(err) {
            const el = document.getElementById('errorMsg');
            el.style.display = 'block';
            el.innerText = `Verbindungsfehler: ${err.message}`;
            console.error(err);
        }

        // DB SYNC
        function subscribeToList(listId) {
            const listRef = doc(db, "shopping_lists", listId);
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?list=' + listId;
            window.history.pushState({path:newUrl},'',newUrl);

            onSnapshot(listRef, (snap) => {
                if (snap.exists()) {
                    items = snap.data().items || [];
                    renderList();
                } else {
                    saveItems([]);
                }
            }, handleError);
        }

        async function saveItems(newItems) {
            try {
                await setDoc(doc(db, "shopping_lists", currentListId), { items: newItems }, { merge: true });
            } catch (e) { handleError(e); }
        }

        // LOGIC
        window.addItem = async () => {
            const input = document.getElementById('inputField');
            const text = input.value.trim();
            if(!text) return;
            const newItem = smartMode ? parseSmart(text) : createSimpleItem(text);
            await saveItems([...items, newItem]);
            input.value = '';
        };

        window.addRecipe = async (type) => {
            const recipes = {
                'breakfast': ['Eier', 'Milch', 'Mehl', 'Bacon'],
                'pasta': ['Nudeln', 'Tomatenso√üe', 'Parmesan', 'Basilikum'],
                'party': ['Chips', 'Cola', 'Bier', 'Pizza'],
                'cleaning': ['Reiniger', 'Schw√§mme', 'M√ºllbeutel']
            };
            const newItems = recipes[type].map(name => ({
                id: Date.now() + Math.random(), name, amount: 1, unit: 'x', category: 'Rezept', checked: false
            }));
            await saveItems([...items, ...newItems]);
            showToast(`Rezept hinzugef√ºgt!`);
        };

        window.updateQty = async (id, change) => {
            const updated = items.map(i => {
                if(i.id === id) {
                    let amount = parseFloat(i.amount) || 1;
                    amount += change; if(amount < 1) amount = 1;
                    return { ...i, amount: amount };
                } return i;
            });
            await saveItems(updated);
        };

        window.toggleCheck = async (id) => {
            await saveItems(items.map(i => i.id === id ? { ...i, checked: !i.checked } : i));
        };

        window.deleteItem = async (id) => {
            const item = items.find(i => i.id === id);
            lastDeletedItems = [item];
            await saveItems(items.filter(i => i.id !== id));
            showToast(`"${item.name}" gel√∂scht`, true);
        };

        window.clearChecked = async () => {
            const toDelete = items.filter(i => i.checked);
            if(toDelete.length === 0) return;
            lastDeletedItems = toDelete;
            await saveItems(items.filter(i => !i.checked));
            showToast(`${toDelete.length} gel√∂scht`, true);
        };

        window.finishShopping = async () => {
            if(!items.some(i => i.checked)) return alert("Nichts erledigt!");
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.7 } });
            window.clearChecked();
        };

        // UNDO
        function showToast(msg, showUndo = false) {
            const toast = document.getElementById('undoToast');
            document.getElementById('toastMsg').innerText = msg;
            document.getElementById('undoToast').querySelector('.undo-btn').style.display = showUndo ? 'block' : 'none';
            toast.classList.add('show');
            clearTimeout(undoTimeout);
            undoTimeout = setTimeout(() => toast.classList.remove('show'), 4000);
        }

        window.performUndo = async () => {
            if(lastDeletedItems.length > 0) {
                await saveItems([...items, ...lastDeletedItems]);
                lastDeletedItems = [];
                document.getElementById('undoToast').classList.remove('show');
            }
        };

        // SPEECH RECOGNITION (Added Back)
        function initSpeech() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SR();
                recognition.lang = 'de-DE';
                recognition.continuous = false;
                
                recognition.onstart = () => {
                    document.getElementById('micBtn').classList.add('active');
                    document.getElementById('inputField').placeholder = "Ich h√∂re zu...";
                };
                recognition.onend = () => {
                    document.getElementById('micBtn').classList.remove('active');
                    document.getElementById('inputField').placeholder = "Was fehlt?";
                };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('inputField').value = transcript;
                };
            } else {
                document.getElementById('micBtn').style.display = 'none';
            }
        }
        initSpeech(); // Start logic

        window.toggleDictation = () => {
            if (!recognition) return alert("Mikrofon nicht unterst√ºtzt.");
            if (document.getElementById('micBtn').classList.contains('active')) recognition.stop();
            else recognition.start();
        };

        // HELPERS
        function createSimpleItem(text) { return { id: Date.now(), name: text, amount: 1, unit: '', category: 'Manuell', checked: false }; }
        
        function parseSmart(text) {
            const categories = {
                "Obst & Gem√ºse": ["apfel", "banane", "salat", "gurke", "tomate", "zwiebel", "kartoffel"],
                "K√ºhlregal": ["milch", "k√§se", "joghurt", "butter", "sahne", "ei", "wurst"],
                "Vorrat": ["brot", "nudeln", "reis", "mehl", "zucker", "√∂l", "konserve"],
                "Getr√§nke": ["wasser", "saft", "bier", "cola", "limo", "kaffee"],
                "Haushalt": ["papier", "reiniger", "waschmittel", "zahnpasta"]
            };
            let clean = text;
            const amountRegex = /^(\d+[.,]?\d*)\s*(kg|g|l|ml|stk|pkg)?/i;
            let amount = 1, unit = "";
            const match = clean.match(amountRegex);
            if(match) { amount = parseFloat(match[1]); unit = match[2] || ""; clean = clean.replace(match[0], "").trim(); }
            let category = "Sonstiges";
            const lower = clean.toLowerCase();
            for(const [cat, keywords] of Object.entries(categories)) {
                if(keywords.some(k => lower.includes(k))) { category = cat; break; }
            }
            return { id: Date.now(), name: clean.charAt(0).toUpperCase() + clean.slice(1), amount, unit, category, checked: false };
        }

        window.toggleMode = () => {
            smartMode = !smartMode;
            const btn = document.getElementById('modeBtn');
            const input = document.getElementById('inputField');
            if(smartMode) {
                btn.innerText = "‚ú®"; btn.className = "action-btn mode-btn";
                input.placeholder = "Was fehlt? (Smart)";
            } else {
                btn.innerText = "üìù"; btn.className = "action-btn mode-btn simple";
                input.placeholder = "Was fehlt? (Text)";
            }
            input.focus();
        };

        window.handleEnter = (e) => { if(e.key === 'Enter') window.addItem(); };
        window.shareList = () => { navigator.clipboard.writeText(window.location.href); alert("Link kopiert!"); };

        function renderList() {
            const container = document.getElementById('listContainer');
            container.innerHTML = '';
            if(items.length === 0) {
                document.getElementById('emptyState').style.display = 'block'; return;
            }
            document.getElementById('emptyState').style.display = 'none';

            const groups = {};
            const sorted = [...items].sort((a,b) => a.checked - b.checked);
            sorted.forEach(item => {
                const cat = item.category || "Sonstiges";
                if(!groups[cat]) groups[cat] = [];
                groups[cat].push(item);
            });

            const order = ["Obst & Gem√ºse", "K√ºhlregal", "Vorrat", "Getr√§nke", "Haushalt", "Rezept", "Manuell", "Sonstiges"];
            const allKeys = new Set([...order, ...Object.keys(groups)]);

            allKeys.forEach(cat => {
                if(groups[cat] && groups[cat].length > 0) {
                    const title = document.createElement('div');
                    title.className = 'cat-title'; title.innerText = cat;
                    container.appendChild(title);
                    groups[cat].forEach(item => {
                        const row = document.createElement('div');
                        row.className = `item-row ${item.checked ? 'checked' : ''}`;
                        const displayUnit = item.unit === 'x' ? '' : item.unit;
                        
                        let qtyHtml = '';
                        if(smartMode || item.amount > 1) {
                             qtyHtml = `
                                <div class="qty-control" onclick="event.stopPropagation()">
                                    <div class="qty-btn" onclick="updateQty(${item.id}, -1)">-</div>
                                    <div class="qty-val">${item.amount}${displayUnit}</div>
                                    <div class="qty-btn" onclick="updateQty(${item.id}, 1)">+</div>
                                </div>`;
                        }
                        row.innerHTML = `
                            <div class="check-box" onclick="toggleCheck(${item.id})"></div>
                            <div class="details" onclick="toggleCheck(${item.id})">
                                <div class="name">${item.name}</div>
                            </div>
                            ${qtyHtml}
                            <button class="del-btn" onclick="deleteItem(${item.id})">&times;</button>
                        `;
                        container.appendChild(row);
                    });
                }
            });
        }
    </script>
</body>
</html>

