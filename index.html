<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Einkaufs-Assistent</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <!-- Diese beiden Dateien musst du im selben Ordner haben -->
  <script src="produktVorlagen.js"></script>
  <script src="gemini-api.js"></script>
  <style>
    :root {
      --bg-color: #f0fdf4;
      --text-color: #1b1b1b;
      --primary-color: #22c55e;
      --primary-hover: #16a34a;
      --card-bg: #ffffff;
      --border-color: #cce3d3;
      --shadow-color: rgba(0,0,0,0.05);
      --input-bg: #ffffff;
      --disabled-color: #a0a0a0;
      --erledigt-opacity: 0.6;
      --header-bg: #dcfce7;
      --tab-active-border: var(--primary-color);
      --tab-inactive-color: #4b5563;
    }

    body.dark-mode {
      --bg-color: #1f2937;
      --text-color: #f9fafb;
      --primary-color: #22c55e;
      --primary-hover: #16a34a;
      --card-bg: #374151;
      --border-color: #4b5563;
      --shadow-color: rgba(0,0,0,0.2);
      --input-bg: #4b5563;
      --disabled-color: #9ca3af;
      --erledigt-opacity: 0.5;
      --header-bg: #111827;
      --tab-active-border: var(--primary-color);
      --tab-inactive-color: #d1d5db;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 1rem;
      max-width: 600px;
      margin: auto;
      padding-bottom: 6rem; /* Platz für FAB */
    }

    /* --- Header & Tabs --- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      background-color: var(--header-bg);
      padding: 0.5rem 1rem;
      border-radius: 12px;
    }
    h1 {
      font-size: 1.5rem;
      color: var(--primary-color);
    }
    #darkModeToggle {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.5rem;
      cursor: pointer;
    }
    .tabs {
      display: flex;
      margin-bottom: 1rem;
      border-bottom: 2px solid var(--border-color);
    }
    .tab-button {
      flex: 1;
      padding: 0.8rem;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-size: 1rem;
      font-weight: 600;
      color: var(--tab-inactive-color);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .tab-button.active {
      color: var(--text-color);
      border-bottom-color: var(--tab-active-border);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* --- Bedienelemente (Filter, etc.) --- */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .control-item { flex: 1; }
    
    input, button, select, textarea {
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 0.8rem;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      font-size: 1rem;
      background-color: var(--input-bg);
      color: var(--text-color);
    }
    textarea { min-height: 100px; }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: var(--primary-hover); }
    button.secondary {
      background-color: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }
    button.secondary:hover { background-color: var(--border-color); }
    button.danger {
      background-color: #ef4444;
      color: white;
    }
    button.danger:hover { background-color: #dc2626; }
    button:disabled {
      background-color: var(--disabled-color);
      cursor: not-allowed;
    }

    /* --- Produkt Liste --- */
    ul { list-style-type: none; padding: 0; }
    li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      margin-bottom: 0.5rem;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 1px 4px var(--shadow-color);
      transition: all 0.3s ease;
    }
    .produkt-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex: 1;
      cursor: pointer;
      overflow: hidden; /* Für Notizen */
    }
    .produkt-info i {
      font-size: 1.5rem;
      color: var(--primary-color);
    }
    .produkt-details {
      flex: 1;
      overflow: hidden;
    }
    .produkt-details strong {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .kategorie, .notiz, .von-benutzer {
      display: block;
      font-size: 0.85rem;
      color: var(--disabled-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .notiz, .von-benutzer { font-style: italic; }
    
    .erledigt .produkt-details {
      text-decoration: line-through;
      opacity: var(--erledigt-opacity);
    }

    .aktionen button {
      margin-left: 0.5rem;
      padding: 0.5rem;
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
      border-radius: 50%;
    }
    .vorrat-item .aktionen button {
      background-color: #3b82f6; /* Blau für "zurück zur Liste" */
    }

    /* --- FAB (Floating Action Button) --- */
    #fab {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 2.5rem;
      line-height: 1;
      padding: 0;
      z-index: 999;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    body.einkaufsmodus #fab { display: none; }

    /* --- Modals (Pop-ups) --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: var(--bg-color);
      margin: auto;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 0.5rem;
      right: 1rem;
      font-size: 2rem;
      font-weight: bold;
      color: var(--disabled-color);
      cursor: pointer;
    }
    .modal-content h3 {
      margin-bottom: 1rem;
      text-align: center;
    }
    .favoriten-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.5rem;
    }
    .favoriten-grid button {
      padding: 0.5rem;
      font-size: 0.9rem;
    }
    
    /* Checkbox-Styling */
    .checkbox-label {
      display: flex; 
      align-items: center; 
      gap: 0.5rem; 
      margin-bottom: 1rem;
      font-size: 1rem;
      cursor: pointer;
    }
    .checkbox-label input[type="checkbox"] {
      width: auto; 
      margin: 0;
      height: 1.2em;
      width: 1.2em;
    }


    /* --- Popups (Undo, etc.) --- */
    #undoPopup, #loeschPopup, #erledigtPopup {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      padding: 1rem;
      border-radius: 5px;
      display: none;
      z-index: 1001;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    #loeschPopup, #erledigtPopup {
      bottom: auto;
      top: 50%;
      transform: translate(-50%, -50%);
      background: var(--card-bg);
      color: var(--text-color);
    }
    #feuerwerk {
      display: block;
      margin: auto;
    }

  </style>
</head>
<body>

  <div class="header">
    <h1>Einkaufs-Assistent</h1>
    <button id="darkModeToggle" onclick="toggleDarkMode()">
      <i class="bi bi-moon-stars-fill"></i>
    </button>
  </div>

  <nav class="tabs">
    <button class="tab-button active" onclick="zeigeTab(event, 'liste')">Einkaufsliste</button>
    <button class="tab-button" onclick="zeigeTab(event, 'vorrat')">Vorratskammer</button>
  </nav>

  <!-- ======================== -->
  <!-- TAB: EINKAUFSLISTE       -->
  <!-- ======================== -->
  <div id="listenContainer" class="tab-content active">
    
    <div class="controls">
      <button id="einkaufsmodusBtn" class="control-item" onclick="toggleEinkaufsmodus()">Einkaufsmodus</button>
    </div>
    
    <div class="controls" id="shopping-controls" style="display: none;">
      <select id="marktFilter" class="control-item" onchange="renderListe()">
        <option value="">Alle Märkte</option>
      </select>
      <select id="sortKategorie" class="control-item" onchange="renderListe()">
        <option value="">Sortieren</option>
      </select>
    </div>

    <div class="controls" id="edit-controls">
      <button class="control-item" onclick="starteKiAnalyse()">
        <i class="bi bi-magic"></i> Liste analysieren
      </button>
      <button class="control-item secondary" onclick="raeumeErledigteAuf()">
        <i class="bi bi-check2-circle"></i> Erledigte aufräumen
      </button>
    </div>

    <ul id="liste"></ul>
  </div>

  <!-- ======================== -->
  <!-- TAB: VORRATSKAMMER       -->
  <!-- ======================== -->
  <div id="vorratsContainer" class="tab-content">
    <div class="controls">
      <input type="text" id="vorratFilterInput" onkeyup="renderVorratskammer()" placeholder="Vorratskammer durchsuchen..." class="control-item" style="flex-basis: 100%;">
      <!-- NEUER BUTTON: KI-Koch-Assistent -->
      <button class="control-item secondary" onclick="starteVorratAnalyse()">
          <i class="bi bi-lightbulb"></i> Was kochen? (KI)
      </button>
    </div>
    <ul id="vorratListe"></ul>
  </div>

  <!-- ======================== -->
  <!-- FAB - HINZUFÜGEN BUTTON  -->
  <!-- ======================== -->
  <button id="fab" onclick="oeffneHinzufuegenModal()"><i class="bi bi-plus-lg"></i></button>


  <!-- ======================== -->
  <!-- MODALS (Pop-ups)         -->
  <!-- ======================== -->

  <!-- Modal 1: Hinzufügen-Zentrale -->
  <div id="hinzufuegenModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="schliesseAlleModals()">&times;</span>
      <h3>Neues Produkt</h3>
      
      <nav class="tabs">
        <button id="tabBtnManuell" class="tab-button active" onclick="zeigeHinzufuegenTab(event, 'manuell')">Manuell</button>
        <button id="tabBtnSprache" class="tab-button" onclick="zeigeHinzufuegenTab(event, 'sprache')">Sprache</button>
        <button id="tabBtnRezept" class="tab-button" onclick="zeigeHinzufuegenTab(event, 'rezept')">Rezept-KI</button>
      </nav>

      <!-- Manuell Tab -->
      <div id="tabManuell" class="tab-content active">
        <input type="text" id="produktInput" placeholder="Produktname...">
        <input type="text" id="mengeInput" placeholder="Menge (z.B. 2 Stück)">
        <input type="text" id="marktInput" placeholder="Markt (optional)">
        <input type="text" id="notizInput" placeholder="Notiz (optional)">
        <button onclick="manuellHinzufuegen()">Hinzufügen</button>
      </div>
      
      <!-- Sprache Tab -->
      <div id="tabSprache" class="tab-content">
        <button onclick="starteSpracheingabe()" id="spracheBtn">
          <i class="bi bi-mic-fill"></i> Aufnahme starten
        </button>
        <p id="spracheStatus" style="text-align: center; margin-top: 1rem;"></p>
      </div>

      <!-- Rezept-KI Tab -->
      <div id="tabRezept" class="tab-content">
        <textarea id="rezeptInput" placeholder="Hier ein Rezept oder eine Zutatenliste einfügen..."></textarea>
        <button onclick="starteRezeptAnalyse()" id="rezeptKiBtn">
          <i class="bi bi-card-checklist"></i> Rezept verarbeiten
        </button>
      </div>

      <hr style="margin: 1.5rem 0;">
      <h3>Favoriten</h3>
      <div class="favoriten-grid" id="favoritenGrid">
        <!-- Favoriten werden per JS geladen -->
      </div>

    </div>
  </div>

  <!-- Modal 2: Abhaken & Vorrat (NEU) -->
  <div id="checkoffModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="schliesseAlleModals()">&times;</span>
      <h3>Produkt abhaken</h3>
      <p>Produkt <strong id="checkoffProduktName"></strong> als erledigt markieren.</p>
      <label class="checkbox-label">
        <input type="checkbox" id="inVorratCheckbox">
        In die Vorratskammer verschieben?
      </label>
      <button id="checkoffSpeichernBtn">Speichern</button>
    </div>
  </div>
  
  <!-- Modal 3: Produkt bearbeiten -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="schliesseAlleModals()">&times;</span>
      <h3>Produkt bearbeiten</h3>
      <input type="hidden" id="editIdInput">
      <input type="text" id="editNameInput" placeholder="Produktname">
      <input type="text" id="editMengeInput" placeholder="Menge">
      <input type="text" id="editMarktInput" placeholder="Markt">
      <input type="text" id="editNotizInput" placeholder="Notiz">
      <input type="text" id="editKategorieInput" placeholder="Kategorie">
      <button onclick="speichereEdit()">Änderungen speichern</button>
    </div>
  </div>

  <!-- Modal 4: KI Analyse Ergebnisse -->
  <div id="kiAnalyseModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="schliesseAlleModals()">&times;</span>
      <h3>KI Analyse</h3>
      <div id="kiAnalyseErgebnis">
        <p>Analysiere Liste...</p>
      </div>
    </div>
  </div>

  <!-- NEUES MODAL: Benutzername -->
  <div id="benutzerModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Willkommen!</h3>
      <p>Wie ist dein Name? Dieser wird angezeigt, wenn du Produkte zu einer geteilten Liste hinzufügst.</p>
      <input type="text" id="benutzerNameInput" placeholder="Dein Name...">
      <button onclick="speichereBenutzer()">Speichern</button>
    </div>
  </div>

  <!-- Andere Popups -->
  <div id="undoPopup">
    <span>Produkt gelöscht.</span>
    <button onclick="undoLoeschen()" class="secondary">Rückgängig</button>
  </div>
  
  <div id="loeschPopup">
    <p id="matheFrage"></p>
    <input type="number" id="matheAntwort" placeholder="Antwort eingeben">
    <button onclick="pruefeAntwort()" class="danger">Bestätigen</button>
    <button onclick="abbrechenLoeschen()" class="secondary">Abbrechen</button>
  </div>
  
  <div id="erledigtPopup">
    <canvas id="feuerwerk" width="300" height="150"></canvas>
    <h3>Super, alles erledigt!</h3>
  </div>

<script>
    // --- FIREBASE KONFIGURATION ---
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD7pocrD9_46QNoz1jrxggpzkL7E6IhetY",
  authDomain: "einkaufliste-cd5d3.firebaseapp.com",
  databaseURL: "https://einkaufliste-cd5d3-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "einkaufliste-cd5d3",
  storageBucket: "einkaufliste-cd5d3.firebasestorage.app",
  messagingSenderId: "36721747923",
  appId: "1:36721747923:web:dbe48ff974c80435eff126",
  measurementId: "G-37TDK0257N"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const LISTEN_ID = params.get("list") || "standardliste";
    const listenRef = db.collection("einkaufslisten").doc(LISTEN_ID);

    // --- GLOBALE VARIABLEN ---
    let produkte = [];
    let vorrat = [];
    let zuletztGeloescht = null;
    let einkaufsmodusAktiv = false;
    let recognition = null; // Für Spracheingabe
    let benutzerName = "Gast"; // NEU: Benutzername

    // --- DATENBANK-LISTENER ---
    listenRef.onSnapshot(doc => {
      if (doc.exists) {
        const data = doc.data();
        produkte = data.produkte || [];
        vorrat = data.vorrat || [];
        
        // Benutzer initialisieren (nur einmal)
        initialisiereBenutzer(); 
        
        aktualisiereDropdowns();
        renderListe();
        renderVorratskammer();
      } else {
        console.log("Neues Dokument wird erstellt.");
        initialisiereBenutzer(); // Auch hier aufrufen
        speichereAlles(); // Erstellt das Dokument, falls nicht vorhanden
      }
    });

    function speichereAlles() {
      const zuSpeicherndeProdukte = produkte.map(p => ({
        id: p.id,
        name: p.name,
        menge: p.menge,
        markt: p.markt,
        notiz: p.notiz,
        kategorie: p.kategorie,
        icon: p.icon,
        erledigt: p.erledigt,
        hinzugefuegtVon: p.hinzugefuegtVon || "Gast" // NEU: Benutzer mitspeichern
      }));
      listenRef.set({ 
        produkte: zuSpeicherndeProdukte, 
        vorrat: vorrat
      }).catch(err => console.error("Fehler beim Speichern: ", err));
    }

    // --- UI FUNKTIONEN (TABS, MODALS, DARK MODE) ---

    function zeigeTab(event, tabName) {
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      document.querySelectorAll('.tabs .tab-button').forEach(tb => tb.classList.remove('active'));
      
      document.getElementById(`${tabName}Container`).classList.add('active');
      event.currentTarget.classList.add('active');
      
      document.getElementById('fab').style.display = (tabName === 'liste' && !einkaufsmodusAktiv) ? 'block' : 'none';
    }

    function zeigeHinzufuegenTab(event, tabName) {
      document.querySelectorAll('#hinzufuegenModal .tab-content').forEach(tc => tc.classList.remove('active'));
      document.querySelectorAll('#hinzufuegenModal .tab-button').forEach(tb => tb.classList.remove('active'));
      document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
      event.currentTarget.classList.add('active');
    }

    function oeffneHinzufuegenModal() {
      document.getElementById('hinzufuegenModal').style.display = 'flex';
      ladeFavoriten();
    }
    
    function schliesseAlleModals() {
      document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
      if (recognition) {
        recognition.stop();
        recognition = null;
      }
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const icon = document.getElementById('darkModeToggle').querySelector('i');
      if (document.body.classList.contains('dark-mode')) {
        icon.classList.remove('bi-moon-stars-fill');
        icon.classList.add('bi-sun-fill');
        localStorage.setItem('darkMode', 'enabled');
      } else {
        icon.classList.remove('bi-sun-fill');
        icon.classList.add('bi-moon-stars-fill');
        localStorage.setItem('darkMode', 'disabled');
      }
    }
    
    if (localStorage.getItem('darkMode') === 'enabled') {
      toggleDarkMode();
    }
    
    function toggleEinkaufsmodus() {
      einkaufsmodusAktiv = !einkaufsmodusAktiv;
      document.body.classList.toggle("einkaufsmodus", einkaufsmodusAktiv);
      
      const btn = document.getElementById("einkaufsmodusBtn");
      btn.classList.toggle("active", einkaufsmodusAktiv);
      btn.innerHTML = einkaufsmodusAktiv ? "Bearbeiten-Modus" : "Einkaufsmodus";
      
      document.getElementById("edit-controls").style.display = einkaufsmodusAktiv ? "none" : "flex";
      document.getElementById("shopping-controls").style.display = einkaufsmodusAktiv ? "flex" : "none";
      document.getElementById("fab").style.display = einkaufsmodusAktiv ? "none" : "block";
      
      renderListe(); // Moduswechsel erfordert Neurenderung
    }

    // --- NEU: BENUTZER-FUNKTIONEN ---
    let benutzerInitialisiert = false;
    function initialisiereBenutzer() {
      if (benutzerInitialisiert) return; // Nur einmal ausführen
      
      const lokalerName = localStorage.getItem('benutzerName');
      if (lokalerName) {
        benutzerName = lokalerName;
      } else {
        // Verzögerung, damit die App erst laden kann
        setTimeout(() => {
            document.getElementById('benutzerModal').style.display = 'flex';
        }, 500);
      }
      benutzerInitialisiert = true;
    }

    function speichereBenutzer() {
      const nameInput = document.getElementById('benutzerNameInput').value.trim();
      if (nameInput) {
        benutzerName = nameInput;
        localStorage.setItem('benutzerName', benutzerName);
        schliesseAlleModals();
      } else {
        alert("Bitte gib einen Namen ein.");
      }
    }

    // --- RENDER FUNKTIONEN (LISTE & VORRAT) ---
    function renderListe() {
      const ul = document.getElementById("liste");
      if (!ul) return; 
      ul.innerHTML = '';
      
      const kat = document.getElementById("sortKategorie").value;
      const markt = document.getElementById("marktFilter").value;

      let gefiltert = [...produkte];
      
      if (einkaufsmodusAktiv) {
        gefiltert = gefiltert.filter(p => !p.erledigt);
        if (markt) gefiltert = gefiltert.filter(p => p.markt === markt);
      } else {
        gefiltert.sort((a, b) => a.erledigt - b.erledigt);
      }

      if (kat) {
        gefiltert = gefiltert.filter(p => p.kategorie === kat);
      }
      
      if (gefiltert.length === 0 && einkaufsmodusAktiv && produkte.length > 0 && produkte.some(p=> p.erledigt)) {
        zeigeErledigtPopup();
      }

      gefiltert.forEach(p => {
        const li = document.createElement("li");
        li.className = p.erledigt ? 'erledigt' : '';
        // NEU: .von-benutzer Span hinzugefügt
        li.innerHTML = `
          <span class="produkt-info" onclick="toggleErledigt(${p.id})">
            <i class="bi ${p.icon || 'bi-bag'}"></i>
            <div class="produkt-details">
              <strong>${p.name}</strong>
              <span class="kategorie">${p.menge} ${p.markt ? '• ' + p.markt : ''} ${p.kategorie ? '• ' + p.kategorie : ''}</span>
              ${p.notiz ? `<span class="notiz">${p.notiz}</span>` : ''}
              ${p.hinzugefuegtVon && p.hinzugefuegtVon !== "Gast" ? `<span class="von-benutzer"><i>Von: ${p.hinzugefuegtVon}</i></span>` : ''}
            </div>
          </span>
          <span class="aktionen">
            ${!einkaufsmodusAktiv ? `
              <button class="secondary" onclick="event.stopPropagation(); oeffneEditModal(${p.id})"><i class="bi bi-pencil"></i></button>
              <button class="danger" onclick="event.stopPropagation(); loescheProdukt(${p.id})"><i class="bi bi-trash"></i></button>
            ` : ''}
          </span>`;
        ul.appendChild(li);
      });
    }
    
    function renderVorratskammer() {
      const ul = document.getElementById("vorratListe");
      if (!ul) return; 
      const filter = document.getElementById("vorratFilterInput").value.toLowerCase();
      ul.innerHTML = '';
      
      vorrat
        .filter(p => p.name.toLowerCase().includes(filter))
        .sort((a,b) => a.name.localeCompare(b.name))
        .forEach(p => {
          const li = document.createElement("li");
          li.className = 'vorrat-item';
          li.innerHTML = `
            <span class="produkt-info">
              <i class="bi ${p.icon || 'bi-box-seam'}"></i>
              <div class="produkt-details">
                <strong>${p.name}</strong>
                <span class="kategorie">${p.menge || ''}</span>
              </div>
            </span>
            <span class="aktionen">
              <button onclick="verschiebeInListe(${p.id})"><i class="bi bi-arrow-up-left-circle"></i></button>
            </span>`;
          ul.appendChild(li);
        });
    }

    function aktualisiereDropdowns() {
      const katSet = new Set(produkte.map(p => p.kategorie).filter(k => k));
      const marktSet = new Set(produkte.map(p => p.markt).filter(m => m));
      
      const sortKategorie = document.getElementById("sortKategorie");
      sortKategorie.innerHTML = '<option value="">Nach Kategorie sortieren</option>';
      Array.from(katSet).sort().forEach(k => {
        sortKategorie.innerHTML += `<option value="${k}">${k}</option>`;
      });
      
      const marktFilter = document.getElementById("marktFilter");
      marktFilter.innerHTML = '<option value="">Alle Märkte filtern</option>';
      Array.from(marktSet).sort().forEach(m => {
        marktFilter.innerHTML += `<option value="${m}">${m}</option>`;
      });
    }

    // --- PRODUKT-LOGIK (HINZUFÜGEN, BEARBEITEN, LÖSCHEN) ---

    function manuellHinzufuegen() {
        const name = document.getElementById('produktInput').value.trim();
        if (!name) {
            alert("Bitte gib einen Produktnamen ein.");
            return; 
        }
        hinzufuegen(); 
        schliesseAlleModals();
    }
    
    function hinzufuegen(produktObj = null) {
      let name, menge, markt, notiz, kategorie, icon;

      if (produktObj) {
        name = produktObj.name.trim();
        menge = produktObj.menge || "1 Stück";
        markt = produktObj.markt || "";
        notiz = produktObj.notiz || "";
      } else {
        name = document.getElementById('produktInput').value.trim();
        menge = document.getElementById('mengeInput').value.trim() || "1 Stück";
        markt = document.getElementById('marktInput').value.trim();
        notiz = document.getElementById('notizInput').value.trim();
      }

      if (!name) return;

      const mengenMatch = menge.match(/^(\d+[\.,]?\d*)\s*(.*)/);
      let zahl = 1;
      let einheit = menge;
      if (mengenMatch) {
        zahl = parseFloat(mengenMatch[1].replace(',', '.'));
        einheit = mengenMatch[2].trim() || "Stück";
      }

      const bestehend = produkte.find(p => 
        !p.erledigt &&
        p.name.toLowerCase() === name.toLowerCase() &&
        p.markt === markt &&
        p.menge.toLowerCase().endsWith(einheit.toLowerCase())
      );

      if (bestehend) {
        const bestMatch = bestehend.menge.match(/^(\d+[\.,]?\d*)\s*(.*)/);
        let bestZahl = parseFloat(bestMatch[1].replace(',', '.'));
        bestehend.menge = `${bestZahl + zahl} ${einheit}`;
        if (notiz) bestehend.notiz = (bestehend.notiz ? bestehend.notiz + "; " : "") + notiz;
        // NEU: Benutzer aktualisieren, falls ein anderer hinzufügt
        bestehend.hinzugefuegtVon = benutzerName; 
      } else {
        const vorlage = findeProduktVorlage(name);
        if (vorlage && !produktObj) { 
          kategorie = vorlage.kategorie;
          icon = vorlage.icon;
          menge = menge === "1 Stück" ? (vorlage.menge || menge) : menge; 
        } else if (produktObj && produktObj.kategorie) {
          kategorie = produktObj.kategorie;
          icon = produktObj.icon || 'bi-bag';
        } else {
          kategorie = "Sonstiges";
          icon = "bi-bag";
        }

        const id = Date.now();
        // NEU: 'hinzugefuegtVon' beim Erstellen setzen
        produkte.push({ id, name, menge, markt, notiz, kategorie, icon, erledigt: false, hinzugefuegtVon: benutzerName });
      }
      
      speichereAlles();
      
      if (!produktObj) {
        document.getElementById('produktInput').value = '';
        document.getElementById('mengeInput').value = '';
        document.getElementById('marktInput').value = '';
        document.getElementById('notizInput').value = '';
      }
    }

    function findeProduktVorlage(eingabe) {
      if (typeof produktVorlagen === 'undefined') return null;
      const n = eingabe.toLowerCase();
      return produktVorlagen.find(p => p.name.toLowerCase() === n);
    }
    
    function ladeFavoriten() {
      const grid = document.getElementById('favoritenGrid');
      grid.innerHTML = '';
      if (typeof produktVorlagen === 'undefined') return;
      
      produktVorlagen.filter(p => p.favorit).forEach(p => {
        const btn = document.createElement('button');
        btn.className = 'secondary';
        btn.innerHTML = `<i class="bi ${p.icon || 'bi-bag'}"></i> ${p.name}`;
        btn.onclick = () => {
          hinzufuegen({
            name: p.name,
            menge: p.menge,
            kategorie: p.kategorie,
            icon: p.icon
          });
        };
        grid.appendChild(btn);
      });
    }

    function toggleErledigt(id) {
      const p = produkte.find(p => p.id === id);
      if (!p) return;

      if (!p.erledigt && einkaufsmodusAktiv) {
        oeffneCheckoffModal(p);
      } else {
        p.erledigt = false;
        speichereAlles();
      }
    }

    function loescheProdukt(id) {
      zuletztGeloescht = produkte.find(p => p.id === id);
      produkte = produkte.filter(p => p.id !== id);
      speichereAlles();
      zeigeUndo();
    }
    
    function raeumeErledigteAuf() {
      const erledigte = produkte.filter(p => p.erledigt);
      if (erledigte.length === 0) {
        alert("Es gibt keine erledigten Produkte zum Aufräumen.");
        return;
      }
      if (confirm(`Möchtest du ${erledigte.length} erledigte Produkte entfernen?`)) {
        produkte = produkte.filter(p => !p.erledigt);
        speichereAlles();
      }
    }

    // --- BEARBEITEN-MODAL ---
    function oeffneEditModal(id) {
      const p = produkte.find(p => p.id === id);
      if (!p) return;
      document.getElementById('editIdInput').value = p.id;
      document.getElementById('editNameInput').value = p.name;
      document.getElementById('editMengeInput').value = p.menge;
      document.getElementById('editMarktInput').value = p.markt || '';
      document.getElementById('editNotizInput').value = p.notiz || '';
      document.getElementById('editKategorieInput').value = p.kategorie || '';
      document.getElementById('editModal').style.display = 'flex';
    }

    function speichereEdit() {
      const id = parseInt(document.getElementById('editIdInput').value);
      const p = produkte.find(p => p.id === id);

      if (!p) {
        schliesseAlleModals();
        return;
      }
      
      p.name = document.getElementById('editNameInput').value;
      p.menge = document.getElementById('editMengeInput').value;
      p.markt = document.getElementById('editMarktInput').value;
      p.notiz = document.getElementById('editNotizInput').value;
      p.kategorie = document.getElementById('editKategorieInput').value;
      
      const vorlage = findeProduktVorlage(p.name);
      p.icon = vorlage ? vorlage.icon : 'bi-bag';
      
      // Benutzername beim Bearbeiten nicht ändern
      
      speichereAlles();
      schliesseAlleModals(); 
    }
    
    // --- VORRATSKAMMER-LOGIK ---
    function verschiebeInListe(vorratId) {
      const p = vorrat.find(p => p.id === vorratId);
      if (!p) return;
      
      hinzufuegen({
        name: p.name,
        menge: p.menge,
        kategorie: p.kategorie,
        icon: p.icon
      });
      
      vorrat = vorrat.filter(v => v.id !== vorratId);
      speichereAlles();
    }

    // --- ABHAKEN-MODAL ---
    function oeffneCheckoffModal(produkt) {
      document.getElementById('checkoffProduktName').textContent = produkt.name;
      document.getElementById('inVorratCheckbox').checked = false;
      document.getElementById('checkoffModal').style.display = 'flex';
      
      document.getElementById('checkoffSpeichernBtn').onclick = () => speichereCheckoff(produkt.id);
    }

    function speichereCheckoff(id) {
      const p = produkte.find(p => p.id === id);

      if (!p) {
        schliesseAlleModals();
        return;
      }
      
      const inVorrat = document.getElementById('inVorratCheckbox').checked;
      
      p.erledigt = true;
      
      if (inVorrat) {
        const vorratExistiert = vorrat.find(v => v.name.toLowerCase() === p.name.toLowerCase());
        if (!vorratExistiert) {
          vorrat.push({
            id: p.id,
            name: p.name,
            menge: p.menge,
            kategorie: p.kategorie,
            icon: p.icon
            // 'hinzugefuegtVon' wird nicht im Vorrat benötigt
          });
        }
      }
      
      speichereAlles();
      schliesseAlleModals(); 
    }
    
    // --- KI-FUNKTIONEN (Erfordert gemini-api.js) ---
    async function starteKiAnalyse() {
      if (typeof callGeminiApi !== 'function') {
        alert("KI-Modul (gemini-api.js) nicht geladen.");
        return;
      }
      
      const unerledigteProdukte = produkte
        .filter(p => !p.erledigt)
        .map(p => `${p.name} (${p.menge})`);
        
      if (unerledigteProdukte.length < 2) {
        alert("Füge mindestens 2 Produkte hinzu, damit die KI die Liste analysieren kann.");
        return;
      }

      const modalInhalt = document.getElementById('kiAnalyseErgebnis');
      modalInhalt.innerHTML = "<p>Analysiere Liste... <i class='bi bi-robot'></i></p>";
      document.getElementById('kiAnalyseModal').style.display = 'flex';
      
      const prompt = `
        Hier ist eine Einkaufsliste: ${unerledigteProdukte.join(', ')}.
        Analysiere diese Liste. Was fehlt wahrscheinlich? 
        Beispiel: Wenn "Nudeln, Hackfleisch" da sind, fehlt "Tomatensauce".
        Gib mir 3-5 Vorschläge für Produkte, die logisch dazu passen.
        Antworte NUR mit einer JSON-Liste von Objekten im Format:
        [{"name": "Produkt A"}, {"name": "Produkt B"}]
        Kein Text davor oder danach.
      `;
      
      try {
        const kiAntwort = await callGeminiApi(prompt);
        const vorschlaege = JSON.parse(kiAntwort);
        
        modalInhalt.innerHTML = "<h4>Vorschläge (Was fehlt?):</h4>";
        if (vorschlaege.length === 0) {
          modalInhalt.innerHTML += "<p>Sieht vollständig aus!</p>";
        }
        
        vorschlaege.forEach(v => {
          modalInhalt.innerHTML += `
            <button class="secondary" style="margin-bottom: 0.5rem;" onclick="hinzufuegen({name: '${v.name}'}); this.disabled=true; this.textContent='Hinzugefügt'">
              <i class="bi bi-plus-lg"></i> ${v.name}
            </button>
          `;
        });
      } catch (err) {
        console.error("KI-Analyse-Fehler: ", err);
        modalInhalt.innerHTML = "<p>Fehler bei der KI-Analyse. Hast du deinen API-Key in `gemini-api.js` eingetragen?</p>";
      }
    }
    
    // NEU: KI-KOCH-ASSISTENT
    async function starteVorratAnalyse() {
      if (typeof callGeminiApi !== 'function') {
        alert("KI-Modul (gemini-api.js) nicht geladen.");
        return;
      }
      
      if (vorrat.length < 2) {
        alert("Füge mindestens 2 Produkte in deine Vorratskammer ein, damit die KI ein Rezept vorschlagen kann.");
        return;
      }

      const vorratListe = vorrat.map(p => p.name).join(', ');

      const modalInhalt = document.getElementById('kiAnalyseErgebnis');
      modalInhalt.innerHTML = "<p>Suche Rezept basierend auf Vorrat... <i class='bi bi-robot'></i></p>";
      document.getElementById('kiAnalyseModal').style.display = 'flex';
      
      const prompt = `
        Hier ist mein aktueller Vorrat: ${vorratListe}.
        Schlage mir ein einfaches Rezept (1-2 Portionen) vor, das viele dieser Zutaten nutzt.
        Liste 1-3 wichtige Zutaten auf, die mir WAHRSCHEINLICH FEHLEN, um das Rezept zu kochen.
        Ignoriere Standardzutaten wie Salz, Pfeffer, Öl, es sei denn, es ist eine spezielle Sorte (z.B. Olivenöl).
        Antworte NUR mit einer JSON-Antwort im Format:
        {"rezeptName": "Name des Rezepts", "fehlendeZutaten": [{"name": "Fehlende Zutat A", "menge": "z.B. 100g"}, {"name": "Fehlende Zutat B", "menge": "z.B. 1 Stk"}]}
      `;
      
      try {
        const kiAntwort = await callGeminiApi(prompt);
        const vorschlag = JSON.parse(kiAntwort);
        
        modalInhalt.innerHTML = `<h4>Rezeptvorschlag:</h4><p><strong>${vorschlag.rezeptName}</strong></p><hr><p>Fehlende Zutaten (zur Liste hinzufügen):</p>`;
        
        if (vorschlag.fehlendeZutaten.length === 0) {
          modalInhalt.innerHTML += "<p>Du scheinst alles zu haben!</p>";
        }
        
        vorschlag.fehlendeZutaten.forEach(z => {
          modalInhalt.innerHTML += `
            <button class="secondary" style="margin-bottom: 0.5rem;" onclick="hinzufuegen({name: '${z.name}', menge: '${z.menge}'}); this.disabled=true; this.textContent='Hinzugefügt'">
              <i class="bi bi-plus-lg"></i> ${z.name} (${z.menge})
            </button>
          `;
        });
      } catch (err) {
        console.error("KI-Vorratsanalyse-Fehler: ", err);
        modalInhalt.innerHTML = "<p>Fehler bei der Rezept-Analyse. Hast du deinen API-Key in `gemini-api.js` eingetragen?</p>";
      }
    }
    
    async function starteRezeptAnalyse() {
      if (typeof callGeminiApi !== 'function') {
        alert("KI-Modul (gemini-api.js) nicht geladen.");
        return;
      }
      
      const rezeptText = document.getElementById('rezeptInput').value;
      if (!rezeptText) {
        alert("Bitte füge ein Rezept ein.");
        return;
      }
      
      const btn = document.getElementById('rezeptKiBtn');
      btn.disabled = true;
      btn.innerHTML = "<i class='bi bi-hourglass-split'></i> Verarbeite...";
      
      const prompt = `
        Extrahiere die Zutaten aus diesem Text. 
        Ignoriere Mengenangaben, die bereits vorhanden sein sollten (z.B. "Salz", "Pfeffer", "Öl").
        Erstelle eine JSON-Liste von Objekten. Nutze die 'produktVorlagen.js', um die korrekte Kategorie und Icon zu finden.
        Das Format muss sein:
        [
          {"name": "Tomaten", "menge": "500 g", "kategorie": "Gemüse", "icon": "bi-egg"},
          {"name": "Hackfleisch", "menge": "1 Pfund", "kategorie": "Fleisch", "icon": "bi-list-ul"}
        ]
        Text: "${rezeptText}"
      `;
      
      try {
        const kiAntwort = await callGeminiApi(prompt);
        const zutaten = JSON.parse(kiAntwort);
        
        zutaten.forEach(z => {
          hinzufuegen(z);
        });
        
        schliesseAlleModals();
        alert(`${zutaten.length} Zutaten wurden zur Liste hinzugefügt.`);
      } catch (err) {
        console.error("Rezept-KI-Fehler: ", err);
        alert("Fehler bei der Rezept-Analyse. Bitte prüfe die Konsole und deinen API-Key.");
      } finally {
        btn.disabled = false;
        btn.innerHTML = "<i class='bi bi-card-checklist'></i> Rezept verarbeiten";
      }
    }

    // --- SPRACHEINGABE ---
    function starteSpracheingabe() {
      if (!('webkitSpeechRecognition' in window)) {
        alert("Spracherkennung wird von diesem Browser nicht unterstützt.");
        return;
      }
      
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'de-DE';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      
      const status = document.getElementById('spracheStatus');
      const btn = document.getElementById('spracheBtn');
      
      recognition.onstart = () => {
        status.textContent = "Höre zu...";
        btn.disabled = true;
      };
      
      recognition.onresult = (event) => {
        const text = event.results[0][0].transcript;
        status.textContent = `Erkannt: "${text}"`;
        hinzufuegen({ name: text });
      };
      
      recognition.onerror = (event) => {
        status.textContent = "Fehler bei der Erkennung. Nochmal versuchen.";
        console.error("Spracherkennungsfehler: ", event.error);
      };
      
      recognition.onend = () => {
        status.textContent = "";
        btn.disabled = false;
      };
      
      recognition.start();
    }
    
    // --- SONSTIGE HILFSFUNKTIONEN ---
    function zeigeUndo() {
      const popup = document.getElementById("undoPopup");
      popup.style.display = "block";
      setTimeout(() => popup.style.display = "none", 5000);
    }

    function undoLoeschen() {
      if (zuletztGeloescht) {
        produkte.push(zuletztGeloescht);
        speichereAlles(); 
        zuletztGeloescht = null;
        document.getElementById("undoPopup").style.display = "none";
      }
    }

    function teileURL() {
      const url = `${location.origin}${location.pathname}?list=${LISTEN_ID}`;
      if (navigator.share) {
        navigator.share({
          title: 'Einkaufs-Assistent',
          text: 'Hier ist unsere gemeinsame Einkaufsliste:',
          url
        });
      } else {
        navigator.clipboard.writeText(url).then(() => alert("Link kopiert: " + url));
      }
    }

    // "Alles Löschen"-Sicherheitsabfrage
    let richtigeAntwort = 0;
    function zeigeLoeschAbfrage() {
      const a = Math.floor(Math.random() * 10 + 1);
      const b = Math.floor(Math.random() * 10 + 1);
      richtigeAntwort = a + b;
      document.getElementById("matheFrage").textContent = `Sicher? Was ist ${a} + ${b}?`;
      document.getElementById("matheAntwort").value = "";
      document.getElementById("loeschPopup").style.display = "block";
    }

    function pruefeAntwort() {
      const eingabe = parseInt(document.getElementById("matheAntwort").value);
      if (eingabe === richtigeAntwort) {
        produkte = [];
        vorrat = [];
        speichereAlles();
        document.getElementById("loeschPopup").style.display = "none";
      } else {
        alert("Falsche Antwort.");
      }
    }

    function abbrechenLoeschen() {
      document.getElementById("loeschPopup").style.display = "none";
    }
    
    // "Alles erledigt"-Feuerwerk
    function zeigeErledigtPopup() {
      const popup = document.getElementById("erledigtPopup");
      if (!popup) return;
      popup.style.display = "block";
      starteFeuerwerk();

      setTimeout(() => {
        popup.style.display = "none";
        stopFeuerwerk();
      }, 5000);
    }

    let interval;
    function starteFeuerwerk() {
      const canvas = document.getElementById("feuerwerk");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      interval = setInterval(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < 30; i++) {
          const x = Math.random() * canvas.width;
          const y = Math.random() * canvas.height;
          const r = Math.random() * 3 + 2;
          ctx.beginPath();
          ctx.arc(x, y, r, 0, Math.PI * 2);
          ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 60%)`;
          ctx.fill();
        }
      }, 100);
    }
    function stopFeuerwerk() {
      clearInterval(interval);
    }
    
</script>
</body>
</html>


