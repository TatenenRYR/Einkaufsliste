<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meine Einkaufsliste</title>
  <style>
    /* ... Hier dein CSS von oben einf√ºgen ... */
    /* F√ºr K√ºrze lasse ich den CSS-Code weg, bitte aus deinem bisherigen Code √ºbernehmen */
  </style>
</head>
<body>
  <div class="container">
    <header>Meine Einkaufsliste</header>
    <div class="controls">
      <input type="text" id="itemInput" list="suggestions" placeholder="Produkt eingeben..." autocomplete="off" />
      <datalist id="suggestions"></datalist>
      <input type="text" id="categoryInput" placeholder="Kategorie eingeben... (optional)" />
      <button id="addBtn">Hinzuf√ºgen</button>
    </div>
    <div id="list"></div>
    <div class="footer">
      <button class="share" id="shareBtn">Liste teilen</button>
      <button class="clear" id="clearBtn">Liste l√∂schen</button>
    </div>
  </div>

  <script>
    let suggestions = ['Milch','Brot','Eier','√Ñpfel','Bananen','Wasser','K√§se','Butter','Tomaten','Reis','Nudeln','Kaffee','Tee','Zucker','Mehl'];
    let list = [];

    // Hilfsfunktionen wie detectCategory und iconMap kannst du aus deinem bisherigen Code √ºbernehmen

    // --- API-Funktionen ---
    async function fetchList() {
      const res = await fetch('/api/list');
      list = await res.json();
      updateSuggestions();
      renderList();
    }

    async function saveList() {
      // Wird nur genutzt bei Add/Delete/Update API-Calls
    }

    async function addItem() {
      const nameEl = document.getElementById('itemInput');
      const catEl = document.getElementById('categoryInput');
      const name = nameEl.value.trim();
      if (!name) return alert('Bitte Produkt eingeben');
      let category = catEl.value.trim();
      if (!category) category = detectCategory(name);

      if (!suggestions.includes(name)) {
        suggestions.push(name);
        updateSuggestions();
      }

      const existing = list.find(i => i.name.toLowerCase() === name.toLowerCase());
      if (existing) {
        await updateItem(existing.name, { qty: existing.qty + 1 });
      } else {
        await fetch('/api/list', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, category, checked: false, qty: 1 }),
        });
      }
      nameEl.value = '';
      catEl.value = '';
      await fetchList();
    }

    async function updateItem(name, changes) {
      await fetch(`/api/list/${encodeURIComponent(name)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(changes),
      });
    }

    async function deleteItem(name) {
      await fetch(`/api/list/${encodeURIComponent(name)}`, {
        method: 'DELETE',
      });
    }

    async function toggleItem(idx) {
      const item = list[idx];
      await updateItem(item.name, { checked: !item.checked });
      await fetchList();
    }

    async function changeQty(idx, delta) {
      const item = list[idx];
      const newQty = item.qty + delta;
      if (newQty <= 0) {
        if (confirm(`M√∂chtest du "${item.name}" wirklich l√∂schen?`)) {
          await deleteItem(item.name);
        }
      } else {
        await updateItem(item.name, { qty: newQty });
      }
      await fetchList();
    }

    // Rendering und UI-Funktionen (aus deinem Code)

    function updateSuggestions() {
      const dataList = document.getElementById('suggestions');
      dataList.innerHTML = '';
      suggestions.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        dataList.appendChild(option);
      });
    }

    function getCategoryIcon(category, name) {
      // Deine Icon-Logik hier einf√ºgen (wie bisher)
      // Beispiel:
      const iconMap = [
        { keywords: ['getr√§nk','milch','wasser','saft','cola','bier','wein','kaffee','tee'], icon:'ü•§' },
        { keywords: ['obst','gem√ºse','apfel','banane','tomate'], icon:'üçé' },
        { keywords: ['fleisch','wurst','schinken','h√§hnchen','steak','fisch'], icon:'ü•©' },
        { keywords: ['brot','keks','kuchen','backwaren'], icon:'ü•ê' },
        { keywords: ['k√§se','butter','joghurt'], icon:'üßÄ' },
        { keywords: ['reis','nudeln'], icon:'üçö' },
        { keywords: ['hygiene','seife','shampoo'], icon:'üß¥' },
        { keywords: ['haushalt','putz','reiniger'], icon:'üßπ' },
        { keywords: ['eier'], icon:'ü•ö' }
      ];
      const c = category.toLowerCase(); const n = name.toLowerCase();
      for (const e of iconMap) if (e.keywords.some(k => c.includes(k))) return e.icon;
      for (const e of iconMap) if (e.keywords.some(k => n.includes(k))) return e.icon;
      return 'üõí';
    }

    function renderList() {
      const listEl = document.getElementById('list');
      listEl.innerHTML = '';
      list.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'item';
        const icon = getCategoryIcon(item.category, item.name);
        div.innerHTML = `
          <div class="info">
            <span class="item-icon">${icon}</span>
            <span class="item-name${item.checked ? ' checked' : ''}">
              ${item.name} <span class="quantity">x${item.qty}</span>
            </span>
          </div>
          <div class="actions">
            <button onclick="toggleItem(${idx})">${item.checked ? '‚Ü∫' : '‚úî'}</button>
            <button onclick="changeQty(${idx},-1)">‚àí</button>
            <button onclick="changeQty(${idx},1)">+</button>
          </div>
        `;
        div.querySelector('.info').addEventListener('click', () => toggleItem(idx));
        listEl.appendChild(div);
      });
    }

    function shareList() {
      let t = 'Meine Einkaufsliste:%0A';
      list.forEach(i => {
        t += `${i.checked ? '[x]' : '[ ]'} ${i.name} (${i.category}) x${i.qty}%0A`;
      });
      window.open(`https://wa.me/?text=${encodeURIComponent(t)}`, '_blank');
    }

    async function clearList() {
      if (!confirm('M√∂chtest du die gesamte Liste l√∂schen?')) return;
      for (const item of list) {
        await deleteItem(item.name);
      }
      await fetchList();
    }

    document.getElementById('addBtn').addEventListener('click', addItem);
    document.getElementById('shareBtn').addEventListener('click', shareList);
    document.getElementById('clearBtn').addEventListener('click', clearList);

    fetchList();
  </script>
</body>
</html>
